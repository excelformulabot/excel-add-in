<!-- Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT License. -->
<!-- This file shows how to design a first-run page that provides a welcome screen to the user about the features of the add-in. -->

<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>excelformulabot</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css"
        integrity="sha512-xh6O/CkQoPOWDdYTDqeRdPCVd1SpvCA9XXcUnZS2FmJNp1coAFzvtCN9BmamE+4aHK8yyUHUSCcJHgXloTyT2A=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- JavaScript Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3"
        crossorigin="anonymous"></script>

    <!-- Office JavaScript API -->
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1.1/hosted/office.js"></script>

    <!-- For more information on Fluent UI, visit https://developer.microsoft.com/fluentui#/. -->
    <link rel="stylesheet"
        href="https://static2.sharepointonline.com/files/fabric/office-ui-fabric-core/11.0.0/css/fabric.min.css" />

    <!-- Template styles -->
    <link href="taskpane.css" rel="stylesheet" type="text/css" />

    <script src="taskpane.js"></script>
</head>

<body>
  <header class="bg-light py-1 mb-3">
    <div class="container-fluid">
      <div class="row px-0 align-items-center">
        <div class="col">
          <img src="https://d1muf25xaso8hp.cloudfront.net/https%3A%2F%2Fe1b5c549a6dd5273e224cd87b24dd3fb.cdn.bubble.io%2Ff1683076870037x820209632778554600%2FTransparent%2520Black.png?w=256&amp;h=51&amp;auto=compress&amp;dpr=1&amp;fit=max" alt="Logo" class="mt-1 w-100 col-auto">
        </div>
        <div class="col d-flex justify-content-end">
          <button class="btn px-0" id="logout">
            Logout
            <i class="px-2 fas fa-arrow-right-from-bracket"></i>
          </button>
        </div>
      </div>
    </div>
  </header>

<div id="loadScr" class="bg-gray-300 fixed top-0 left-0 w-full h-full" style="display:none;">
  <div class="loadHolder mt-[12rem] ml-[5.5rem]">
    <div class="loader"></div>
  </div>
</div>

<div class="container px-3" id="loginScr" style="display:none;">
  <div class="row">
    <div class="col-12">
      <h5 class="m-0 w-100" >Welcome Back</h5>
    </div>
  </div>
  <div class="row">
    <div class="col-12">
      <div class="text-light-gray">Please enter your details</div>
    </div>
  </div>
  <div class="row">
    <div class="col-12">
      <label class="mt-3 ml-4">Email:</label>
      <input placeholder="Email" id="email" class="form-control form-control-lg border-light shadow-sm" />
    </div>
  </div>
  <div class="row">
    <div class="col-12">
      <label class="mt-3 ml-4">Password:</label>
      <input type="password" placeholder="Password" id="password" class="form-control form-control-lg border-light shadow-sm" />
    </div>
  </div>
  <div class="row mt-4">
    <div class="col-12">
      <button class="btn btn-submit btn-lg rounded-pill w-100" id="login">Login</button>
    </div>
  </div>
  <div class="container text-center mt-2">
    <div class="row">
      <div class="col-12 text-light-gray">
        Don't have an account?
      </div>
    </div>
    <div class="row">
      <div class="col-12">
        <a class="text-decoration-none fw-bolder text-purple" href="http://www.formulabot.com/?utm_source=excel&amp;utm_medium=addon" target="blank">Sign up for free!</a>
      </div>
    </div>
    <div class="row mt-3">
      <div class="col-12">
        <span class="text-light-gray">Experiencing issues? Contact </span><a class="text-decoration-none fw-bolder text-black" href="mailto:hello@formulabot.com">hello@formulabot.com</a>
      </div>
    </div>
  </div>

</div>

<main>
  <!-- MAIN SCREEN -->
  <div class="container-fluid h-100" id="mainScr" style="display:none;">
    <div class="container d-flex justify-content-between align-items-center py-1">
      <button class="btn btn-lg px-2" id="back-button" style="display:none;">
        <i class="fas fa-arrow-left"></i>
      </button>
      <h5 class="m-0 w-100 text-green" id="header-label">I want to...</h5>
    </div>
    <div class="row h-100">
      <!--<div class="col h-100 d-flex align-items-center justify-content-center">-->
        <div class="btn-section-content d-none" id="generate-formula-section">
          <!-- Content for Generate Formula section -->
          <div class="container">
            <div class="row">
                <div class="col-12">
                    <small>Input your text instructions here to generate a formula</small>
                    <textarea type="text" class="form-control form-control-lg" id="txtGenerateInput" rows="6" placeholder="Ex: Give me a formula with the sum of column A when column B contains the word `marketing` and column C is today's date"></textarea>
                </div>
            </div>
            <div class="row py-3">
                <div class="col-12">
                    <button type="button" class="btn btn-submit btn-lg rounded-pill w-100" id="btnSubmitGenerate">Submit</button>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                  <small>Results</small>
                    <textarea type="text" class="form-control form-control-lg mb-3 mb-md-0" id="txtGenerateOutput" rows="3" placeholder="The formula will show here..."></textarea>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-5">
                    <button type="button" class="btn rounded-pill border w-100" id="btnCopyGenerate">Copy</button>
                </div><div class="col-7">
                    <button type="button" class="btn rounded-pill border w-100" id="btnInsertGenerate">Insert in cell</button>
                </div>
            </div>
          </div>
        </div>
        <div class="btn-section-content d-none" id="explain-formula-section">
          <!-- Content for Explain Formula section -->
          <div class="container">
            <div class="row">
                <div class="col-12">
                    <textarea type="text" class="form-control form-control-lg" id="txtExplainInput" rows="3" placeholder="Input your formula here to have it explained"></textarea>
                </div>
            </div>
            <div class="row py-3">
                <div class="col-12">
                    <button type="button" class="btn btn-submit btn-lg rounded-pill w-100" id="btnSubmitExplain">Submit</button>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <textarea type="text" class="form-control form-control-lg mb-3 mb-md-0" id="txtExplainOutput" rows="3" placeholder="Explanation will show here"></textarea>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-5">
                    <button type="button" class="btn rounded-pill border w-100" id="btnCopyExplain">Copy</button>
                </div><div class="col-7">
                    <button type="button" class="btn rounded-pill border w-100" id="btnInsertExplain">Insert in cell</button>
                </div>
            </div>
          </div>
        </div>
        <div class="btn-section-content d-none" id="classify-section">
          <!-- Content for Classify section -->
          <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="text-center fs-5">Classify</div>
                </div>
            </div>
            <div class="row">
              <div class="col-12">
                <input type="text" class="form-control form-control-lg border-light shadow-sm" id="txtClassifyType" placeholder="Company">
              </div>
            </div>
            <div class="row text-center mt-4 py-1">
                <div class="col-12">
                    <div class="text-center fs-5">in cell</div>
                </div>
            </div>
            <div class="row text-center py-1">
                <div class="col-12">
                  <div class="input-group input-group-append rounded shadow-sm">
                    <input type="text" class="form-control form-control-lg border-light" id="txtClassifyRange" placeholder="Ex: B2">
                    <button type="button" class="btn btn-light get-active-range">
                      Copy selected<i class="ps-2 fa-sharp fa-solid fa-copy"></i>
                    </button>
                  </div>
                </div>
            </div>
            <div class="row text-center mt-4 py-1">
                <div class="col-12">
                    <div class="text-center fs-5">based on</div>
                </div>
            </div>
            <div class="row text-center py-1">
                <div class="col-12">
                    <input type="text" class="form-control form-control-lg border-light shadow-sm" id="txtClassifyBasedOn" placeholder="industry">
                </div>
            </div>
            <div class="row text-center mt-4 py-1">
                <div class="col-12">
                    <div class="text-center fs-5">into one of the following groups</div>
                </div>
            </div>
            <div id="txtClassifyCategories">
              <div class="row py-1">
                <div class="col-sm-12 col-md">
                  <div class="input-group input-group-append rounded shadow-sm">
                    <input type="text" class="form-control form-control-lg border-light" placeholder="Group A">
                    <button type="button" class="btn btn-light delete-field">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </div>
              </div>
              <div class="row py-1">
                <div class="col-sm-12 col-md">
                  <div class="input-group input-group-append rounded shadow-sm">
                    <input type="text" class="form-control form-control-lg border-light" placeholder="Group B">
                    <button type="button" class="btn btn-light delete-field">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </div>
              </div>
              <div class="row py-1">
                  <div class="col-12">
                      <a class="text-center text-decoration-none text-purple fw-bolder small" href="#" id="add-field">(+) Add</a>
                  </div>
              </div>
            </div>
            <div class="row mt-4">
                <div class="col-12">
                    <button type="button" class="btn btn-submit btn-lg rounded-pill w-100" id="btnInsertClassify">Insert in cell</button>
                </div>
            </div>
          </div>
        </div>
        <div class="btn-section-content d-none" id="extract-section">
          <!-- Content for Extract section -->
          <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="text-center fs-5">Extract the</div>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <input type="text" class="form-control form-control-lg border-light shadow-sm cell-range" id="txtExtractDescription" placeholder="third word">
                </div>
            </div>
            <div class="row text-center mt-4 py-1">
                <div class="col-12">
                    <div class="text-center fs-5">from</div>
                </div>
            </div>
            <div class="row">
              <div class="col-12">
                <div class="input-group input-group-append rounded shadow-sm">
                  <input type="text" class="form-control form-control-lg border-light bg-gradient" id="txtExtractRange" placeholder="Ex: B2">
                  <button type="button" class="btn btn-light get-active-range">
                      Copy selected<i class="ps-2 fa-sharp fa-solid fa-copy"></i>
                    </button>
                </div>
              </div>
            </div>
            <div class="row mt-4">
                <div class="col-12">
                    <button type="button" class="btn btn-submit btn-lg rounded-pill w-100" id="btnInsertExtract">Insert in cell</button>
                </div>
            </div>
          </div>
        </div>
        <div class="btn-section-content d-none" id="analyze-sentiment-section">
          <!-- Content for Analyze Sentiment section -->
          <div class="container">
              <div class="row">
                  <div class="col-12">
                      <div class="text-center fs-5">Analyze sentiment of</div>
                  </div>
              </div>
              <div class="row">
                  <div class="col-12">
                    <div class="input-group input-group-append rounded shadow-sm">
                      <input type="text" class="form-control form-control-lg border-light bg-gradient" id="txtSentimentRange" placeholder="Ex: B2">
                      <button type="button" class="btn btn-light get-active-range">
                        Copy selected<i class="ps-2 fa-sharp fa-solid fa-copy"></i>
                      </button>
                    </div>
                  </div>
              </div>
              <div class="row text-center mt-4 py-1">
                  <div class="col-12">
                      <div class="text-center fs-5">as one of the following</div>
                  </div>
              </div>
              <div id="txtSentimentCategories">
                <div class="row py-1">
                  <div class="col-sm-12 col-md">
                    <div class="input-group input-group-append rounded shadow-sm">
                      <input type="text" class="form-control form-control-lg border-light" placeholder="Positive">
                      <button type="button" class="btn btn-light delete-field">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </div>
                </div>
                <div class="row py-1">
                  <div class="col-sm-12 col-md">
                    <div class="input-group input-group-append rounded shadow-sm">
                      <input type="text" class="form-control form-control-lg border-light" placeholder="Negative">
                      <button type="button" class="btn btn-light delete-field">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </div>
                </div>
                <div class="row py-1">
                  <div class="col-sm-12 col-md">
                    <div class="input-group input-group-append rounded shadow-sm">
                      <input type="text" class="form-control form-control-lg border-light" placeholder="Neutral">
                      <button type="button" class="btn btn-light delete-field">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </div>
                </div>
                <div class="row py-1">
                  <div class="col-12">
                      <a class="text-center text-decoration-none text-purple fw-bolder small" href="#" id="add-field">(+) Add</a>
                  </div>
                </div>
              </div>
              <div class="row mt-4">
                  <div class="col-12">
                      <button type="button" class="btn btn-submit btn-lg rounded-pill w-100" id="btnInsertSentiment">Insert in cell</button>
                  </div>
              </div>
          </div>
        </div>
        <div class="btn-section-content d-none" id="retrieve-info-section">
          <!-- Content for Retrieve Information section -->
          <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="text-center fs-5">Give me the</div>
                </div>
            </div>
            <div class="row">
              <div class="col-12">
                  <input type="text" class="form-control form-control-lg border-light shadow-sm" id="txtRetrieveDescription" placeholder="Population">
              </div>
            </div>
            <div class="row text-center mt-4 py-1">
                <div class="col-12">
                    <div class="text-center fs-5">of</div>
                </div>
            </div>
            <div class="row">
              <div class="col-12">
                <div class="input-group input-group-append rounded shadow-sm">
                  <input type="text" class="form-control form-control-lg border-light bg-gradient" id="txtRetrieveRange" placeholder="Ex: B2">
                  <button type="button" class="btn btn-light get-active-range">
                      Copy selected<i class="ps-2 fa-sharp fa-solid fa-copy"></i>
                  </button>
                </div>
              </div>
            </div>
            <div class="row mt-4">
                <div class="col-12">
                    <button type="button" class="btn btn-submit btn-lg rounded-pill w-100" id="btnInsertRetrieve">Insert in cell</button>
                    <!--<small class="text-danger fs-5">Error</small>-->
                </div>
            </div>
          </div>
        </div>
        <div class="btn-section-content d-none" id="freeform-section">
          <!-- Content for Freeform section -->
          <div class="container">
            <div class="row">
              <div class="col-12">
                <div>The <span class="fw-bolder">=FORMULABOT_FREEFORM</span> formula lets you type in anything, allowing you to fully customize the response.<br><br>Make sure to be as specific as possible. If you do not get the desired results, try again.
</div>
              </div>
            </div>
            <div class="row fs-5 text-purple">
              <div class="col-12">
                =FORMULABOT_FREEFORM
              </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <button type="button" class="btn rounded-pill border w-100" id="btnCopyFreeform">Copy Formula</button>
                </div>
            </div>
            <div class="row mt-3">
              <div class="col-12">
                <div class="fw-bolder">Examples:</div>
              </div>
            </div>
            <div class="row">
              <div class="col-12">
                <div>=FORMULABOT_FREEFORM(
                  <span class="text-green">“Write me a thank you note to ”,</span>
                  <span class="text-orange">B10</span>
                  <span class="text-green">,“for gifting me a”,</span>
                  <span class="text-orange">C10</span>)
                </div>
              </div>
            </div>
            <div class="row mt-2">
              <div class="col-12">
                <div>=FORMULABOT_FREEFORM(
                  <span class="text-green">“Write me an article about SEO”</span>
                  )
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="btn-section-content d-none" id="infer-section">
          <!-- Content for Infer section -->
          <div class="container">
            <div class="row">
              <div class="col-12">
                <div>The <span class="fw-bolder">=FORMULABOT_INFER</span> formula allows you to insert examples of inputs and outputs to infer additional inputs in which you don't have an output.
</div>
              </div>
            </div>
            <div class="row fs-5 text-purple">
              <div class="col-12">
                =FORMULABOT_INFER
              </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <button type="button" class="btn rounded-pill border w-100" id="btnCopyInfer">Copy Formula</button>
                </div>
            </div>
            <div class="row mt-3">
              <div class="col-12">
                <div class="fw-bolder">Examples:</div>
              </div>
            </div>
            <div class="row">
              <div class="col-12">
                <img src="https://e1b5c549a6dd5273e224cd87b24dd3fb.cdn.bubble.io/f1683555077821x914146478826124900/infer.png" alt="Logo" class="mt-1 img-fluid">
              </div>
            </div>
          </div>
        </div>
      <!--</div>-->
    </div>
  </div>

  <!-- Buttons to show sections -->
  <div class="container" id="home-section">
    <div class="row py-1">
      <div class="col">
        <div class="card px-0" id="generate-formula-button">
          <div class="card-body">
            <h5 class="card-title"><i class="pe-2 fas fa-divide"></i>Generate Formula</h5>
            <p class="card-text">Generate a formula based on text instructions</p>
          </div>
        </div>
      </div>
    </div>
    <div class="row py-1">
      <div class="col">
        <div class="card px-0" id="explain-formula-button">
          <div class="card-body">
            <h5 class="card-title"><i class="pe-2 fas fa-message"></i>Explain Formula</h5>
            <p class="card-text">Input a formula to have it explained for you</p>
          </div>
        </div>
      </div>
    </div>

    <!-- ADVANCED FEATURES -->
    <div class="container border-top border-bottom border-light grid-container list-view px-0 mt-3 pt-3">
      <div class="d-flex align-items-center">
        <h5 class="float-none me-auto text-purple">Advanced Features</h5>
        <button class="btn btn-list px-1 text-purple"><i class="fas fa-list view-type"></i></button>
        <button class="btn btn-grid px-1"><i class="fas fa-grip-vertical view-type "></i></button>
      </div>
      <div class="row gx-1">
        <div class="col-12 card-col">
          <div class="card px-0" id="analyze-sentiment-button">
            <div class="card-body">
              <h5 class="card-title"><i class="pe-2 fas fa-heart-circle-check"></i>Analyze Sentiment</h5>
              <p class="card-text">Determine the sentiment of text, like if it's positive or negative</p>
            </div>
          </div>
        </div>
        <div class="col-12 card-col">
          <div class="card px-0" id="retrieve-info-button">
            <div class="card-body">
              <h5 class="card-title"><i class="pe-2 fas fa-magnifying-glass"></i>Retrieve Information</h5>
              <p class="card-text">Populate information about anything (i.e. a state's capital)</p>
            </div>
          </div>
        </div>
        <div class="col-12 card-col">
          <div class="card px-0" id="classify-button">
            <div class="card-body">
              <h5 class="card-title"><i class="pe-2 fas fa-brands fa-42-group"></i>Classify</h5>
              <p class="card-text">Classify information into multiple categories</p>
            </div>
          </div>
        </div>
        <div class="col-12 card-col">
          <div class="card px-0" id="extract-button">
            <div class="card-body">
              <h5 class="card-title"><i class="pe-2 fas fa-object-ungroup"></i>Extract</h5>
              <p class="card-text">Pull out specific information from a text</p>
            </div>
          </div>
        </div>
        <div class="col-12 card-col">
          <div class="card px-0" id="freeform-button">
            <div class="card-body">
              <h5 class="card-title"><i class="pe-2 fas fa-magnifying-glass"></i>Freeform</h5>
              <p class="card-text">Customize your response by typing anything you want</p>
            </div>
          </div>
        </div>
        <div class="col-12 card-col">
          <div class="card px-0" id="infer-button">
            <div class="card-body">
              <h5 class="card-title"><i class="pe-2 fas fa-wand-magic-sparkles"></i>Infer</h5>
              <p class="card-text">Provide examples of data to infer an output for select inputs</p>
            </div>
          </div>
        </div>
      </div>
      
    </div>
    
    <!-- PASTE VALUES -->
    <div id="paste-widget">
      <div class="row py-1">
          <div class="col">
              <button type="button" class="btn btn-home-paste btn-lg rounded-pill w-100" id="btnPasteValues">
                <div class="fw-bolder section-label">Paste as static values</div>
              </button>
          </div>
      </div>
      <div class="row py-1 mt-2">
          <div class="section-sublabel">
            <div class="row gx-0 align-items-center">
              <div class="col-1 text-end">
                <i class="pe-3 fas fa-circle-info"></i>
              </div>
              <div class="col-11">
                This prevents new results from being pasted in your sheet when the page is refreshed.
              </div>
            </div>
          </div>
      </div>
    </div>
    
  </div>

</main>

<!---------------------------------------------------------------------------->
<!------------------------ BEGIN SPINNING WHEEL MODAL ------------------------>
<!---------------------------------------------------------------------------->
<div class="modal fade" id="modalSpinningWheel" data-bs-backdrop="static" data-bs-keyboard="false"  tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
      </div>
      <div class="modal-body text-center">
        <div class="d-flex justify-content-center">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
        <div>Please wait while we process your request...</div>
        <div class="small fst-italic text-secondary">(Don't click buttons or try to close this as it could interupt the request.)</div>
        </div>
      </div>
    </div>
  </div>
</div>

    <!-- JQUERY -->
    <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.5.1.min.js" type="text/javascript"></script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        var section_labels = {
            'generate-formula-section': 'Generate Formula',
            'explain-formula-section': 'Explain Formula',
            'classify-section': 'Classify',
            'extract-section': 'Extract',
            'analyze-sentiment-section': 'Analyze Sentiment',
            'retrieve-info-section': 'Retrieve Info',
            'freeform-section': 'Freeform',
            'infer-section': 'Infer'
        }

        Office.onReady(async (info) => {
          if (info.host === Office.HostType.Excel) {
            // check if logged in
            await isLoggedIn();

            $('body').on('click', '.btn-grid',async function(event) {
              var $gridCont = $('.grid-container')
              event.preventDefault();

              $gridCont.removeClass('list-view');
              $gridCont.find('.card-text').addClass('d-none');
              $gridCont.find('.card-title').addClass('small');
              
              $gridCont.find('.card-col').removeClass('col-12').addClass('col-6');

              $('.btn-grid').addClass('text-purple');
              $('.btn-list').removeClass('text-purple');
            })
            $('body').on('click', '.btn-list',async function(event) {
              var $gridCont = $('.grid-container');
              event.preventDefault();

              $gridCont.hasClass('list-view') ? $gridCont.removeClass('list-view') : $gridCont.addClass('list-view');
              $gridCont.find('.card-text').removeClass('d-none');
              $gridCont.find('.card-title').removeClass('small');

              $gridCont.find('.card-col').removeClass('col-6').addClass('col-12');

              $('.btn-list').addClass('text-purple');
              $('.btn-grid').removeClass('text-purple');
            });

            // button to click into each section
            $('body').on('click', '.btn-section, .btn-section-advanced', async function (event) {
              const sections = $('.btn-section-content');
              console.log(sections);

              sections.addClass('d-none');

              // Hide home section
              $('#home-section').addClass('d-none');

              // Get button id and replace "button" with "section". button id may need to be the parent if a child div was clicked
              var buttonId = '';
              if (!$(event.target).is('button')) {
                // Get the closest button ancestor with an id ending with "-button"
                const button = $(event.target).closest('button[id$="-button"]');
                buttonId = button.attr('id');
              } else {
                buttonId = $(event.target).attr('id');
              }

              const sectionId = buttonId.replace('button', 'section');

              // Get corresponding section element by id
              const activeSection = $('#' + sectionId);
              console.log('sectionId', event.target.id, 'activeSection', activeSection)

              // Remove class d-none from active section
              activeSection.removeClass('d-none');

              // Set header label
              console.log("sectionId",sectionId,"Header",section_labels[sectionId])
              $('#header-label').text(section_labels[sectionId]);

              // Scroll to the top of the section
              window.scrollTo(0, 0);

              /*// Show spinning wheel
              $('#modalSpinningWheel').modal('show');

              // Delay for 2 seconds before hiding the spinning wheel
              await delay(0.5);

              // Hide spinning wheel
              $('#modalSpinningWheel').modal('hide');*/

              // show back button
              $('#back-button').show();
            });
          }
        });

      // back button
      $('body').on('click','#back-button',async function(event) {
        // hide all divs with id ending in 'section'
        $('div[id$="section"]').addClass('d-none');

        // Set header label
        $('#header-label').text('I want to...');

        // show the home section
        $('#home-section').removeClass('d-none');

        // hide back button
        $('#back-button').hide();
      });


      // select active range button
      $(document).on('click', '.get-active-range', async function(){
        const obj = await getActiveRange();
        var input = $(this).closest(".input-group").find("input");
        $(input).val(obj);
      });


      // add fields button
      $('body').on('click','#add-field', function(event) {
        var newRowHtml = `
          <div class="row py-1">
            <div class="col-sm-12 col-md">
              <div class="input-group input-group-append">
                <input type="text" class="form-control form-control-lg bg-category bg-gradient border-0" value="New category">
                <button type="button" class="btn btn-light delete-field">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
          </div>
        `;
        $(newRowHtml).insertBefore($(this).closest('.row'));
      });

      // delete fields button
      $(document).on('click', '.delete-field', function(){
        $(this).closest('.row').remove();
      });

      ///////////////////////////
      // INSERT BUTTONS
      //////////////////////////
      $(document).on('click', '#btnInsertGenerate', async function(){
        const output = $('#txtGenerateOutput').val();
        await insertCellClientSide(output);
      });

      $(document).on('click', '#btnInsertExplain', async function(){
        const output = $('#txtExplainOutput').val();
        console.log('output',output)
        await insertCellClientSide(output);
      });

      $(document).on('click', '#btnInsertClassify', async function(){
        const inputType = $('#txtClassifyType').val();
        const inputRange = $('#txtClassifyRange').val();
        const inputBasedOn = $('#txtClassifyBasedOn').val();
        var categories = [];
        $('#txtClassifyCategories input').each(function() { 
          if ($(this).val() != '') { 
            categories.push($(this).val().toString()) 
          } 
        });
        categories = categories.filter(itm => itm != '').join('","');
        const formula = `=FORMULABOT.CLASSIFY("${inputType}", ${inputRange}, "${inputBasedOn}", "${categories}")`;
        await insertCellClientSide(formula);
      });

      $(document).on('click', '#btnInsertExtract', async function(){
        const inputRange = $('#txtExtractRange').val();
        const inputDescription = $('#txtExtractDescription').val();
        const formula = `=FORMULABOT.EXTRACT(${inputRange},"${inputDescription}")`;
        await insertCellClientSide(formula);
      });

      $(document).on('click', '#btnInsertSentiment', async function(){
        const inputRange = $('#txtSentimentRange').val();
        var categories = [];
        $('#txtSentimentCategories input').each(function() { 
          categories.push($(this).val()) 
        });
        console.log('categories',categories)
        categories = categories.filter(itm => itm != '').join('","');
        const formula = `=FORMULABOT.SENTIMENT(${inputRange},"${categories}")`;
        await insertCellClientSide(formula);
      });

      $(document).on('click', '#btnInsertRetrieve', async function(){
        const inputRange = $('#txtRetrieveRange').val();
        const inputDescription = $('#txtRetrieveDescription').val();
        const formula = `=FORMULABOT.INFO(${inputRange},"${inputDescription}")`;
        await insertCellClientSide(formula);
      });


      ///////////////////////////
      // SUBMIT BUTTONS
      //////////////////////////
      $(document).on('click', '#btnSubmitGenerate', async function(){
        try {
          var input = $('#txtGenerateInput').val();
          
          // Show spinning wheel
          $('#modalSpinningWheel').modal('show');

          const payload = {
            "input": input.toString(),
            "platform": "Excel Add-in",
            "outputType": "Formula"
          }
          const result = await callAPI('output', payload);
          console.log('btnSubmitGenerate result',result);
          
          $('#txtGenerateOutput').val(result);

          // Hide spinning wheel
          $('#modalSpinningWheel').modal('hide');
        } catch (error) {
          console.error(error);
        }
      });

      
      $(document).on('click', '#btnSubmitExplain', async function(){
        try {
          var input = $('#txtExplainInput').val();
          
          // Show spinning wheel
          $('#modalSpinningWheel').modal('show');
          
          const payload = {
            "input": input.toString(),
            "platform": "Excel Add-in",
            "outputType": "Explain"
          }
          const result = await callAPI('output', payload);
          console.log('btnSubmitExplain result',result);
          
          $('#txtExplainOutput').val(result);

          // Hide spinning wheel
          $('#modalSpinningWheel').modal('hide');
        } catch (error) {
          console.error(error);
        }
        
      });


      $(document).on('click', '#btnPasteValues', async function () {
        // Show spinning wheel
        $('#modalSpinningWheel').modal('show');

        try {
          var count = await replaceFormulasWithValues();

          console.log('count', count);

          // Delay for 0.5 seconds before hiding the spinning wheel
          await delay(0.5);
          $('#modalSpinningWheel').modal('hide');

        } catch (error) {
          console.error(error);

          // Hide spinning wheel in case of error
          $('#modalSpinningWheel').modal('hide');
        }
      });

      
      
      ///////////////////////////
      // COPY BUTTONS
      //////////////////////////
      $(document).on('click', '#btnCopyGenerate, #btnCopyExplain', async function(){
        var output = $(this).attr('id') == 'btnCopyGenerate' ? $('#txtGenerateOutput').val(): $('#txtExplainOutput').val();
        console.log('output',output,'#' + $(this).attr('id'))
        navigator.clipboard.writeText(output);
        updateBtn('#' + $(this).attr('id'),'Copied!','Copy');
      });
      
      

      ///////////////////////////
      // AUTH
      //////////////////////////

      $(document).on('click', '#login', async function(){
        // get email and password
        var email = document.querySelector('#email').value;
        var password = document.querySelector('#password').value;

        // verify email and password have a value
        if(email.indexOf('@') == -1 || password == ''){
          updateBtn('#login','Fill Input Field!','Login');
          return;
        }

        // change button text
        $('#login').text('Logging In...');

        // call server side
        try {
          const url = 'https://formulabot.com/api/1.1/wf/login/';
          const payload = {
            "email": email,
            "password": password
          };
          console.log("payload", payload)
          const options = {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(payload) // Use "body" instead of "payload" for the request body
          };
          console.log('CALL LOGIN OPTIONS', url, options);
          var response = await fetch(url, options);
          console.log(response);
          var resp = await response.json();
          console.log('CALL LOGIN RESP', resp);
          if (resp.status == 'success') {
            localStorage.setItem("token", resp.response.token)
            console.log("res.status", resp.status)
            if (resp.response.subscription == true) {
              $('#login').text('Login');
              $('#email').val('');
              $('#password').val('');
              $('#loginScr').hide();
              $('#mainScr').show();
              $('#home-section').show();
              $('#header-label').show()
              $('#loadScr').hide();
            } else {
              $('#header-label').hide()
              $('#loginScr').show();
              $('#mainScr').hide();
              $('#loadScr').hide();
              updateBtn('#login','Inactive Subscription','Login');
            }
          } else {
              updateBtn('#login', res.message, 'Login');
          }
          if (resp.reason === 'INVALID_LOGIN_CREDENTIALS') {
            updateBtn('#login', 'Invalid Email/Password', 'Login')
            return
          }
          var result = resp?.response?.output ?? 'No Result Found';
          return result;
        } catch (e) {
          return 'No Result Found ' + e;
        }
      });

      $(document).on('click', '#logout', async function(){
        // remove token
        localStorage.removeItem('token')

        // update display
        $('#loginScr').show();
        $('#mainScr').hide();
        $('#loadScr').hide();
        $('#input').val('');
        $('#output').val('');
        $('#home-section').hide();
        $('#header-label').hide()
      });

      ///////////////////////////
      // UTILITIES
      //////////////////////////

      function updateBtn (selector, msg, org) {
        console.log('selector',selector,'msg',msg,'org',org);
        $(selector).text(msg);
        setTimeout(() => {$(selector).text(org)}, 3000);
      }

      async function isLoggedIn () {
        activeState = localStorage.getItem('token');
        console.log("activeState", activeState)
        if (!activeState) {
          $('#loginScr').show();
          $('#mainScr').hide();
          $('#home-section').hide()
          $('#header-label').hide()
          $('#loadScr').hide();
          return;
        } else {
          $('#loginScr').hide();
          $('#mainScr').show();
          $('#home-section').show()
          $('#header-label').show()
          $('#loadScr').hide();
          return;
        }
      }


      function delay(seconds) {
        return new Promise((resolve) => setTimeout(resolve, seconds * 1000));
      }


      function copyFunc() {
        var output = document.querySelector('#output');
        navigator.clipboard.writeText(output.value);
        updateBtn('#copy', 'Copied!', 'Copy');
      }


      function updateBtn(selector, msg, org) {
        var elem = document.querySelector(selector);
        elem.innerText = msg;
        setTimeout(() => { elem.innerText = org }, 2000);
      }

      function insertCellClientSide(formula) {
        try {
            Excel.run(function (context) {
                let range = context.workbook.getSelectedRange();
                range.load("address");
                return context.sync().then(function () {
                    range.values = [[formula]]
                    return context.sync();

                });

            });
        } catch (error) {
            console.error(error);
        }
      }

      async function callAPI(endpoint, payload) {
        const BASE_URL = "https://formulabot.com/api/1.1/wf/";
        var Token = localStorage.getItem("token");
        console.log(Token);
        try {
          const url = BASE_URL + endpoint;
          const options = {
            method: "POST",
            headers: {
              Authorization: `Bearer ${Token}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload), // Use "body" instead of "payload" for the request body
          };
          console.log("CALL API OPTIONS", url, options);
          var response = await fetch(url, options);
          console.log(response);
          var resp = await response.json();
          console.log("CALL API RESP", resp);
          var result = resp?.response?.output ?? "No Result Found";
          return result;
        } catch (e) {
          return "No Result Found " + e;
        }
      }


    </script>
</body>

</html>
